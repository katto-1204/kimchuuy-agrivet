{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/Downloads/inventory-management-system/lib/db.ts"],"sourcesContent":["import mysql from 'mysql2/promise'\r\n\r\nconst pool = mysql.createPool({\r\n  host: process.env.DB_HOST || '127.0.0.1',\r\n  user: process.env.DB_USER || 'root',\r\n  password: process.env.DB_PASSWORD || '',\r\n  database: process.env.DB_DATABASE || 'kimchuyy_agrivet',\r\n  port: Number(process.env.DB_PORT || 3306),\r\n  waitForConnections: true,\r\n  connectionLimit: 10,\r\n  queueLimit: 0,\r\n})\r\n\r\nexport async function query(sql: string, params?: any[]) {\r\n  const [rows] = await pool.query(sql, params)\r\n  return rows\r\n}\r\n\r\nexport default pool\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,OAAO,8IAAK,CAAC,UAAU,CAAC;IAC5B,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,UAAU,QAAQ,GAAG,CAAC,WAAW,IAAI;IACrC,UAAU,QAAQ,GAAG,CAAC,WAAW,IAAI;IACrC,MAAM,OAAO,QAAQ,GAAG,CAAC,OAAO,IAAI;IACpC,oBAAoB;IACpB,iBAAiB;IACjB,YAAY;AACd;AAEO,eAAe,MAAM,GAAW,EAAE,MAAc;IACrD,MAAM,CAAC,KAAK,GAAG,MAAM,KAAK,KAAK,CAAC,KAAK;IACrC,OAAO;AACT;uCAEe"}},
    {"offset": {"line": 145, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/Downloads/inventory-management-system/app/api/sales/route.ts"],"sourcesContent":["import { query } from \"@/lib/db\"\r\nimport pool from \"@/lib/db\"\r\nimport { NextRequest, NextResponse } from \"next/server\"\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const sql = `\r\n      SELECT \r\n        s.*,\r\n        u.full_name as user_name,\r\n        c.name as customer_name,\r\n        GROUP_CONCAT(\r\n          JSON_OBJECT(\r\n            'sale_item_id', si.sale_item_id,\r\n            'product_id', si.product_id,\r\n            'quantity', si.quantity,\r\n            'unit_price', si.unit_price,\r\n            'subtotal', si.subtotal,\r\n            'product_name', p.name,\r\n            'sku', p.sku\r\n          ) SEPARATOR ','\r\n        ) as items_json\r\n      FROM sales s\r\n      LEFT JOIN users u ON s.user_id = u.user_id\r\n      LEFT JOIN customers c ON s.customer_id = c.customer_id\r\n      LEFT JOIN sale_items si ON s.sale_id = si.sale_id\r\n      LEFT JOIN products p ON si.product_id = p.product_id\r\n      GROUP BY s.sale_id\r\n      ORDER BY s.sale_date DESC\r\n      LIMIT 100\r\n    `\r\n    const results = await query(sql, [])\r\n    \r\n    // Parse items_json back to array\r\n    const sales = (results as any[]).map((sale) => {\r\n      const parsed = {\r\n        ...sale,\r\n        items: sale.items_json \r\n          ? JSON.parse(`[${sale.items_json}]`)\r\n          : [],\r\n      }\r\n      delete parsed.items_json\r\n      return parsed\r\n    })\r\n\r\n    return NextResponse.json({ sales })\r\n  } catch (error) {\r\n    console.error(\"GET /api/sales error:\", error)\r\n    return NextResponse.json({ error: \"Failed to fetch sales\" }, { status: 500 })\r\n  }\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json()\r\n    const {\r\n      user_id,\r\n      customer_id,\r\n      items, // Array of { product_id, quantity }\r\n      discount = 0,\r\n      vat,\r\n      total,\r\n      amount_paid,\r\n      change_amount,\r\n      payment_method,\r\n      reference_number,\r\n    } = body\r\n\r\n    if (!items || items.length === 0) {\r\n      return NextResponse.json({ error: \"Cart cannot be empty\" }, { status: 400 })\r\n    }\r\n\r\n    if (!user_id || !payment_method) {\r\n      return NextResponse.json({ error: \"Missing required fields\" }, { status: 400 })\r\n    }\r\n\r\n    // Calculate subtotal from items\r\n    let subtotal = 0\r\n    const itemsWithPrice = []\r\n\r\n    for (const item of items) {\r\n      const productResult = await query(\"SELECT * FROM products WHERE product_id = ?\", [\r\n        item.product_id,\r\n      ])\r\n      const products = productResult as any[]\r\n\r\n      if (products.length === 0) {\r\n        return NextResponse.json(\r\n          { error: `Product ${item.product_id} not found` },\r\n          { status: 404 },\r\n        )\r\n      }\r\n\r\n      const product = products[0]\r\n\r\n      // Check stock\r\n      if (item.quantity > product.stock) {\r\n        return NextResponse.json(\r\n          { error: `Insufficient stock for ${product.name}` },\r\n          { status: 400 },\r\n        )\r\n      }\r\n\r\n      const itemSubtotal = product.price * item.quantity\r\n      subtotal += itemSubtotal\r\n      itemsWithPrice.push({\r\n        product_id: item.product_id,\r\n        quantity: item.quantity,\r\n        unit_price: product.price,\r\n        subtotal: itemSubtotal,\r\n      })\r\n    }\r\n\r\n    // Use a dedicated connection and transaction to ensure consistency\r\n    const conn = await pool.getConnection()\r\n    try {\r\n      await conn.beginTransaction()\r\n\r\n      const [saleResult] = await conn.query(\r\n        `INSERT INTO sales \r\n          (user_id, customer_id, sale_date, subtotal, discount, vat, total, amount_paid, change_amount, payment_method, reference_number)\r\n          VALUES (?, ?, NOW(), ?, ?, ?, ?, ?, ?, ?, ?)`,\r\n        [\r\n          user_id,\r\n          customer_id || null,\r\n          subtotal,\r\n          discount,\r\n          vat || (subtotal - discount) * 0.12,\r\n          total || subtotal - discount + (vat || (subtotal - discount) * 0.12),\r\n          amount_paid,\r\n          change_amount,\r\n          payment_method,\r\n          reference_number || null,\r\n        ],\r\n      )\r\n\r\n      const saleId = (saleResult as any).insertId\r\n\r\n      // Insert sale items and deduct stock\r\n      for (const item of itemsWithPrice) {\r\n        await conn.query(\r\n          `INSERT INTO sale_items (sale_id, product_id, quantity, unit_price, subtotal)\r\n           VALUES (?, ?, ?, ?, ?)`,\r\n          [saleId, item.product_id, item.quantity, item.unit_price, item.subtotal],\r\n        )\r\n\r\n        // Deduct stock\r\n        const [updateResult] = await conn.query(\r\n          `UPDATE products SET stock = stock - ? WHERE product_id = ? AND stock >= ?`,\r\n          [item.quantity, item.product_id, item.quantity],\r\n        )\r\n\r\n        // If stock update affected 0 rows, rollback and return error\r\n        if ((updateResult as any).affectedRows === 0) {\r\n          await conn.rollback()\r\n          conn.release()\r\n          return NextResponse.json(\r\n            { error: `Insufficient stock for product ${item.product_id}` },\r\n            { status: 400 },\r\n          )\r\n        }\r\n      }\r\n\r\n      // Audit log (created_at column exists; don't use non-existent `timestamp`)\r\n      await conn.query(\r\n        `INSERT INTO audit_logs (user_id, action, table_name, record_id, created_at)\r\n         VALUES (?, 'CREATE', 'sales', ?, NOW())`,\r\n        [user_id, saleId],\r\n      )\r\n\r\n      await conn.commit()\r\n      conn.release()\r\n\r\n      return NextResponse.json({\r\n        sale_id: saleId,\r\n        message: \"Sale recorded successfully\",\r\n      })\r\n    } catch (txErr) {\r\n      try {\r\n        await conn.rollback()\r\n      } catch (rbErr) {\r\n        console.error(\"Rollback failed:\", rbErr)\r\n      }\r\n      conn.release()\r\n      console.error(\"Transaction error in POST /api/sales:\", txErr)\r\n      const errMessage = (process.env.NODE_ENV === 'production')\r\n        ? 'Failed to record sale (transaction)'\r\n        : String((txErr as any)?.message || txErr)\r\n      return NextResponse.json({ error: errMessage }, { status: 500 })\r\n    }\r\n  } catch (error) {\r\n    console.error(\"POST /api/sales error:\", error)\r\n    return NextResponse.json({ error: \"Failed to record sale\" }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}